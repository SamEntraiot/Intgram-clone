{% extends 'base.html' %}

{% block title %}Messages - Instagram Clone{% endblock %}

{% block extra_css %}
<style>
    .messages-container {
        display: flex;
        height: calc(100vh - 60px);
        background: var(--primary-bg);
        border: 1px solid var(--border-color);
        border-radius: 0;
        overflow: hidden;
    }

    .conversations-list {
        width: 397px;
        border-right: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
    }

    .conversations-header {
        padding: 20px 24px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .username-dropdown {
        font-weight: 600;
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 4px;
        cursor: pointer;
    }

    .username-dropdown i {
        font-size: 12px;
    }

    .new-message-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 24px;
        color: var(--text-primary);
    }

    .messages-search {
        padding: 0 16px 16px;
        border-bottom: 1px solid var(--border-color);
    }

    .messages-search input {
        width: 100%;
        padding: 8px 16px;
        background: var(--secondary-bg);
        border: none;
        border-radius: 8px;
        font-size: 14px;
    }

    .your-note-section {
        padding: 16px 24px;
        border-bottom: 1px solid var(--border-color);
        text-align: center;
    }

    .note-label {
        font-size: 12px;
        color: var(--text-secondary);
        margin-bottom: 8px;
    }

    .note-avatar {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: var(--border-color);
        margin: 0 auto 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 24px;
        position: relative;
    }

    .note-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 2px 8px;
        font-size: 10px;
        color: var(--text-secondary);
    }

    .note-text {
        font-size: 12px;
        color: var(--text-secondary);
    }

    .messages-tabs {
        display: flex;
        padding: 16px 24px;
        gap: 32px;
        border-bottom: 1px solid var(--border-color);
    }

    .messages-tab {
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        color: var(--text-secondary);
        padding-bottom: 8px;
        border-bottom: 2px solid transparent;
    }

    .messages-tab.active {
        color: var(--text-primary);
        border-bottom-color: var(--text-primary);
    }

    .conversation-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 20px;
        cursor: pointer;
        border-bottom: 1px solid var(--border-color);
        transition: background-color 0.2s;
    }

    .conversation-item:hover {
        background-color: var(--secondary-bg);
    }

    .conversation-item.active {
        background-color: var(--secondary-bg);
    }

    .conversation-avatar {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        object-fit: cover;
    }

    .conversation-info {
        flex: 1;
        overflow: hidden;
    }

    .conversation-username {
        font-weight: 600;
        font-size: 14px;
    }

    .conversation-preview {
        color: var(--text-secondary);
        font-size: 14px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .conversation-preview.unread {
        color: var(--text-primary);
        font-weight: 600;
    }

    .chat-area {
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    .chat-header {
        padding: 16px 20px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .chat-header img {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        object-fit: cover;
    }

    .chat-header-name {
        font-weight: 600;
        font-size: 16px;
    }

    .messages-area {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .message {
        max-width: 60%;
        padding: 12px 16px;
        border-radius: 20px;
        font-size: 14px;
        word-wrap: break-word;
    }

    .message.sent {
        align-self: flex-end;
        background-color: var(--link-color);
        color: white;
    }

    .message.received {
        align-self: flex-start;
        background-color: var(--secondary-bg);
        border: 1px solid var(--border-color);
    }

    .message-time {
        font-size: 11px;
        color: var(--text-secondary);
        margin-top: 4px;
        text-align: right;
    }

    .message.received .message-time {
        text-align: left;
    }

    .chat-input-area {
        padding: 16px 20px;
        border-top: 1px solid var(--border-color);
        display: flex;
        gap: 12px;
        align-items: center;
    }

    .chat-input-area input {
        flex: 1;
        border: 1px solid var(--border-color);
        border-radius: 22px;
        padding: 12px 20px;
        font-size: 14px;
        outline: none;
    }

    .send-btn {
        background: none;
        border: none;
        color: var(--link-color);
        font-weight: 600;
        cursor: pointer;
        font-size: 14px;
    }

    .send-btn:disabled {
        opacity: 0.3;
        cursor: default;
    }

    .empty-state {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: var(--text-secondary);
    }

    .empty-state .messenger-icon {
        width: 96px;
        height: 96px;
        border: 3px solid var(--text-primary);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 24px;
    }

    .empty-state .messenger-icon i {
        font-size: 48px;
        color: var(--text-primary);
    }

    .empty-state h2 {
        font-size: 22px;
        font-weight: 300;
        margin-bottom: 12px;
        color: var(--text-primary);
    }

    .empty-state p {
        font-size: 14px;
        color: var(--text-secondary);
        margin-bottom: 24px;
    }

    .send-message-btn {
        background: var(--link-color);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 8px 24px;
        font-weight: 600;
        cursor: pointer;
        font-size: 14px;
    }

    .no-messages-text {
        text-align: center;
        padding: 80px 40px;
        color: var(--text-secondary);
        font-size: 14px;
    }

    /* New Message Modal Styles */
    #newMessageModal .modal-body {
        padding: 0;
    }

    #newMessageModal .form-group {
        padding: 16px;
        border-bottom: 1px solid var(--border-color);
    }

    #newMessageModal .form-group label {
        font-weight: 600;
        font-size: 16px;
        margin-right: 8px;
    }

    #newMessageModal .form-group input {
        flex: 1;
        border: none;
        outline: none;
        font-size: 14px;
        padding: 8px 0;
    }

    #newMessageModal .form-group {
        display: flex;
        align-items: center;
    }

    #userSearchResults {
        max-height: 400px;
        overflow-y: auto;
    }

    #userSearchResults .conversation-item {
        border-bottom: none;
    }

    .search-no-results {
        text-align: center;
        padding: 40px;
        color: var(--text-secondary);
        font-size: 14px;
    }

    /* User Profile Modal */
    .user-profile-preview {
        text-align: center;
    }

    .user-profile-avatar-large {
        width: 90px;
        height: 90px;
        border-radius: 50%;
        object-fit: cover;
        margin: 0 auto 16px;
    }

    .user-profile-username-large {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 4px;
        color: var(--text-primary);
    }

    .user-profile-fullname {
        font-size: 16px;
        color: var(--text-secondary);
        margin-bottom: 16px;
    }

    .user-profile-stats {
        display: flex;
        justify-content: center;
        gap: 40px;
        padding: 16px 0;
        border-top: 1px solid var(--border-color);
        border-bottom: 1px solid var(--border-color);
        margin: 16px 0;
    }

    .user-profile-stat {
        text-align: center;
    }

    .user-profile-stat-value {
        font-weight: 600;
        font-size: 14px;
        display: block;
        color: var(--text-primary);
    }

    .user-profile-stat-label {
        font-size: 12px;
        color: var(--text-secondary);
    }

    .profile-action-buttons {
        display: flex;
        gap: 8px;
        margin-top: 16px;
    }

    .profile-action-btn {
        flex: 1;
        padding: 8px 16px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        border: none;
    }

    .profile-action-btn.primary {
        background: var(--link-color);
        color: white;
    }

    .profile-action-btn.secondary {
        background: var(--secondary-bg);
        color: var(--text-primary);
    }

    @media (max-width: 768px) {
        .conversations-list {
            width: 100%;
        }

        .chat-area {
            display: none;
        }

        .chat-area.active {
            display: flex;
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--primary-bg);
            z-index: 100;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="messages-container">
    <div class="conversations-list">
        <div class="conversations-header">
            <div class="username-dropdown" id="usernameDropdown">
                <span id="currentUsername">username</span>
                <i class="fas fa-chevron-down"></i>
            </div>
            <button class="new-message-btn" onclick="openNewMessageModal()">
                <i class="far fa-edit"></i>
            </button>
        </div>

        <div class="messages-search">
            <input type="text" placeholder="Search" id="conversationsSearch">
        </div>

        <div class="your-note-section">
            <div class="note-label">Note...</div>
            <div class="note-avatar">
                <i class="fas fa-user" style="color: white;"></i>
            </div>
            <div class="note-text">Your note</div>
        </div>

        <div class="messages-tabs">
            <div class="messages-tab active">Messages</div>
            <div class="messages-tab">Requests</div>
        </div>

        <div id="conversationsList">
            <div class="no-messages-text">No messages found.</div>
        </div>
    </div>

    <div class="chat-area" id="chatArea">
        <div class="empty-state">
            <div class="messenger-icon">
                <i class="fab fa-facebook-messenger"></i>
            </div>
            <h2>Your messages</h2>
            <p>Send a message to start a chat.</p>
            <button class="send-message-btn" onclick="openNewMessageModal()">Send message</button>
        </div>
    </div>
</div>

<!-- New Message Modal -->
<div id="newMessageModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3>New Message</h3>
            <button class="close-modal" onclick="closeModal('newMessageModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>To:</label>
                <input type="text" id="userSearchInput" placeholder="Search username...">
            </div>
            <div id="userSearchResults"></div>
        </div>
    </div>
</div>

<!-- User Profile Preview Modal -->
<div id="userProfileModal" class="modal">
    <div class="modal-content" style="max-width: 400px; border-radius: 12px;">
        <div class="modal-body" style="padding: 0;">
            <div id="userProfileContent" style="text-align: center; padding: 32px;">
                <!-- Profile content will be loaded here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let conversations = [];
    let currentConversation = null;
    let messagesInterval = null;
    let currentUser = null;

    async function loadConversations() {
        try {
            conversations = await apiCall('/conversations/');
            renderConversations();
        } catch (error) {
            console.error('Error loading conversations:', error);
            document.getElementById('conversationsList').innerHTML = 
                '<div class="no-messages-text">No conversations yet. Start a new message!</div>';
        }
    }

    function renderConversations() {
        const container = document.getElementById('conversationsList');
        
        if (conversations.length === 0) {
            container.innerHTML = '<div class="no-messages-text">No conversations yet. Start a new message!</div>';
            return;
        }

        container.innerHTML = conversations.map(conv => {
            const otherUser = conv.participants.find(p => p.username !== currentUser?.username);
            const lastMsg = conv.last_message;
            
            return `
                <div class="conversation-item" onclick="openConversation(${conv.id})">
                    <img src="${otherUser?.profile?.avatar || 'https://via.placeholder.com/56'}" alt="${otherUser?.username}" class="conversation-avatar">
                    <div class="conversation-info">
                        <div class="conversation-username">${otherUser?.username || 'User'}</div>
                        <div class="conversation-preview ${lastMsg?.is_read ? '' : 'unread'}">
                            ${lastMsg?.text || 'Start a conversation'}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    async function openConversation(conversationId) {
        currentConversation = conversationId;
        
        // Mark conversation as active
        document.querySelectorAll('.conversation-item').forEach(item => {
            item.classList.remove('active');
        });
        event.currentTarget?.classList.add('active');

        // Load messages
        await loadMessages(conversationId);
        
        // Start polling for new messages
        if (messagesInterval) clearInterval(messagesInterval);
        messagesInterval = setInterval(() => loadMessages(conversationId), 3000);

        // Show chat area on mobile
        document.getElementById('chatArea').classList.add('active');
    }

    async function loadMessages(conversationId) {
        try {
            const messages = await apiCall(`/conversations/${conversationId}/messages/`);
            const conversation = conversations.find(c => c.id === conversationId);
            const otherUser = conversation?.participants.find(p => p.username !== currentUser?.username);

            const chatArea = document.getElementById('chatArea');
            chatArea.innerHTML = `
                <div class="chat-header">
                    <img src="${otherUser?.profile?.avatar || 'https://via.placeholder.com/32'}" alt="${otherUser?.username}">
                    <span class="chat-header-name">${otherUser?.username || 'User'}</span>
                </div>
                <div class="messages-area" id="messagesArea">
                    ${messages.length === 0 ? '<div class="search-no-results">No messages yet. Say hi!</div>' : ''}
                    ${messages.reverse().map(msg => `
                        <div class="message ${msg.sender === currentUser?.id ? 'sent' : 'received'}">
                            ${msg.text}
                            <div class="message-time">${formatTime(msg.created_at)}</div>
                        </div>
                    `).join('')}
                </div>
                <div class="chat-input-area">
                    <input type="text" id="messageInput" placeholder="Message..." onkeypress="if(event.key==='Enter') sendMessage()">
                    <button class="send-btn" onclick="sendMessage()" id="sendBtn" disabled>Send</button>
                </div>
            `;

            // Enable/disable send button
            document.getElementById('messageInput').addEventListener('input', (e) => {
                document.getElementById('sendBtn').disabled = !e.target.value.trim();
            });

            // Scroll to bottom
            const messagesArea = document.getElementById('messagesArea');
            messagesArea.scrollTop = messagesArea.scrollHeight;
        } catch (error) {
            console.error('Error loading messages:', error);
        }
    }

    async function sendMessage() {
        const input = document.getElementById('messageInput');
        const text = input.value.trim();
        
        if (!text || !currentConversation) return;

        try {
            await apiCall(`/conversations/${currentConversation}/messages/`, {
                method: 'POST',
                body: JSON.stringify({ text })
            });

            input.value = '';
            document.getElementById('sendBtn').disabled = true;
            loadMessages(currentConversation);
        } catch (error) {
            console.error('Error sending message:', error);
            alert('Failed to send message');
        }
    }

    function formatTime(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diff = now - date;
        
        if (diff < 60000) return 'Just now';
        if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
        if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
        return date.toLocaleDateString();
    }

    function openNewMessageModal() {
        document.getElementById('newMessageModal').classList.add('active');
    }

    // User search for new messages
    let searchTimeout;
    document.getElementById('userSearchInput')?.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        const query = e.target.value.trim();
        const results = document.getElementById('userSearchResults');
        
        if (query.length > 0) {
            results.innerHTML = '<div class="search-no-results">Searching...</div>';
            searchTimeout = setTimeout(async () => {
                try {
                    const users = await apiCall(`/search/?q=${query}`);
                    
                    if (users.length === 0) {
                        results.innerHTML = '<div class="search-no-results">No users found</div>';
                        return;
                    }
                    
                    results.innerHTML = users.map(user => `
                        <div class="conversation-item" onclick="showUserProfile('${user.username}')">
                            <img src="${user.profile?.avatar || 'https://via.placeholder.com/56'}" class="conversation-avatar">
                            <div class="conversation-info">
                                <div class="conversation-username">${user.username}</div>
                                <div class="conversation-preview">${user.first_name || user.username}</div>
                            </div>
                        </div>
                    `).join('');
                } catch (error) {
                    console.error('Error searching users:', error);
                    results.innerHTML = '<div class="search-no-results">Failed to search users</div>';
                }
            }, 300);
        } else {
            results.innerHTML = '';
        }
    });

    async function showUserProfile(username) {
        try {
            const profile = await apiCall(`/profile/${username}/`);
            
            const content = document.getElementById('userProfileContent');
            content.innerHTML = `
                <div class="user-profile-preview">
                    <img src="${profile.avatar || 'https://via.placeholder.com/90'}" 
                         class="user-profile-avatar-large" 
                         alt="${profile.username}">
                    <div class="user-profile-username-large">${profile.username}</div>
                    <div class="user-profile-fullname">${profile.user?.first_name || profile.username} â€¢ Instagram</div>
                    
                    <div class="user-profile-stats">
                        <div class="user-profile-stat">
                            <span class="user-profile-stat-value">${profile.posts_count || 0}</span>
                            <span class="user-profile-stat-label">posts</span>
                        </div>
                        <div class="user-profile-stat">
                            <span class="user-profile-stat-value">${profile.followers_count || 0}</span>
                            <span class="user-profile-stat-label">followers</span>
                        </div>
                        <div class="user-profile-stat">
                            <span class="user-profile-stat-value">${profile.following_count || 0}</span>
                            <span class="user-profile-stat-label">following</span>
                        </div>
                    </div>
                    
                    <div class="profile-action-buttons">
                        <button class="profile-action-btn secondary" onclick="window.location.href='/profile/${profile.username}'">
                            View Profile
                        </button>
                        <button class="profile-action-btn primary" onclick="startConversation('${profile.username}')">
                            Message
                        </button>
                    </div>
                </div>
            `;
            
            closeModal('newMessageModal');
            document.getElementById('userProfileModal').classList.add('active');
        } catch (error) {
            console.error('Error loading user profile:', error);
            alert('Failed to load user profile');
        }
    }

    async function startConversation(username) {
        try {
            const conversation = await apiCall('/conversations/create/', {
                method: 'POST',
                body: JSON.stringify({ username })
            });

            closeModal('userProfileModal');
            closeModal('newMessageModal');
            await loadConversations();
            openConversation(conversation.id);
        } catch (error) {
            console.error('Error starting conversation:', error);
            alert('Failed to start conversation');
        }
    }

    // Load current user
    async function loadCurrentUser() {
        try {
            const profile = await apiCall('/profile/me/');
            currentUser = {
                id: profile.user?.id,
                username: profile.username,
                avatar: profile.avatar
            };
            document.getElementById('currentUsername').textContent = profile.username || 'username';
        } catch (error) {
            console.error('Error loading user:', error);
            document.getElementById('currentUsername').textContent = 'username';
        }
    }

    // Initialize
    if (authToken) {
        loadCurrentUser().then(() => {
            loadConversations();
        });
    } else {
        window.location.href = '/login';
    }

    // Cleanup on page leave
    window.addEventListener('beforeunload', () => {
        if (messagesInterval) clearInterval(messagesInterval);
    });
</script>
{% endblock %}
